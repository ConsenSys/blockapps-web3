var EthTx,factory;factory=function(e,t,o,n,r,i){var l,s;return s=function(){function t(e){this.provider=e}return t.prototype.initialize=function(t){this.provider.verbosity>=1&&console.log("   BlockFilter.initialize");var o=this;this.provider.eth_blockNumber(function(n,r){return null!=n?void t(n):(o.block_number=e.toDecimal(r),void t())})},t.prototype.getChanges=function(t){this.provider.verbosity>=1&&console.log("   BlockFilter.getChanges");var o=this;this.provider.eth_blockNumber(function(n,r){return null!=n?void t(n):(r=e.toDecimal(r),void o.getBlockHashesRecursively([],o.block_number,r+1,t))})},t.prototype.getBlockHashesRecursively=function(e,t,o,n){this.provider.verbosity>=1&&console.log("   BlockFilter.getBlockHashesRecursively");var r=this;this.getBlockHash(t,function(i,l){return null!=i?void n(i):(null!=l&&e.push(l),t>=o||null==l?void n(null,e):void r.getBlockHashesRecursively(e,t+1,o,n))})},t.prototype.getBlockHash=function(e,t){this.provider.verbosity>=1&&console.log("   BlockFilter.getBlockHash"),this.provider.requestFromBlockApps("/block?number="+e,function(e){return function(e,o){var n;return null!=e?void t(e):0===o.length?void t():(n=o[0],void t(null,"0x"+n.blockData.parentHash))}}(this))},t}(),l=function(){function l(e){null==e&&(e={}),this.coinbase=e.coinbase,this.accounts=e.accounts||[],this.host=e.host||"http://hacknet.blockapps.net",this.version=e.version||"v1.0",this.blockchain=e.blockchain||"eth",this.verbosity=e.verbosity||0,this.gasPrice=e.gasPrice||1e12,this.keyprovider=e.keyprovider||function(){throw new Error("No key provider given to BlockApps + Web3. Can't send transaction.")},this.filter_index=0,this.filters={}}return l.prototype.send=function(e){throw console.log("Called send!-----------------------"),new Error("BlockAppsWeb3Provider does not support synchronous methods. Please provide a callback.")},l.prototype.sendAsync=function(e,t){e instanceof Array?this.processBatchRequest(e,t):this.processSingleRequest(e,t)},l.prototype.processSingleRequest=function(e,t){var o,n,r,i,l,s,c;if(l=e.method,null==this[l])return void t(new Error("BlockAppsWeb3Provider does not yet support the Web3 method '"+l+"'."));for(o=[],c=e.params||[],r=0,i=c.length;i>r;r++)s=c[r],o.push(s);return o.push(function(o,n){var r;r={id:e.id,jsonrpc:e.jsonrpc,result:n},t(o,r)}),n=this[l],n.length!==o.length?void t(new Error("Invalid number of parameters passed to "+l)):void n.apply(this,o)},l.prototype.processBatchRequest=function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.processBatchRequest");var o=0,n=[],r=this;if(this.verbosity>=1){for(var i="batch start: ",l=0;l<e.length;l++)i+=e[l].method+" ";console.log(i)}var s=function(){r.processSingleRequest(e[o],function(r,i){return null!=r?void t(r):(n.push(i),o+=1,o>=e.length-1?void t(null,n):void s())})};s()},l.prototype.requestFromBlockApps=function(e,o,n,r){var i,l,s,c,u,a;"function"==typeof o&&(r=o,o=null,n="application/x-www-form-urlencoded"),"function"==typeof n&&(r=n,n="application/x-www-form-urlencoded"),u=new t,u.onreadystatechange=function(e){return function(){var t,o,n,i;if(4===u.readyState){n=u.responseText,o=null;try{n=JSON.parse(n)}catch(l){t=l,o=t}e.verbosity>=3&&(i=n,"string"!=typeof i&&(i=JSON.stringify(i,null,2)),console.log("BLOCKAPPS RESPONSE:\n"+i+"\n")),r(o,n)}}}(this),c=null!=o?"POST":"GET";var p=this.host+"/"+this.blockchain+"/"+this.version+e;if(u.open(c,p,!0),u.setRequestHeader("Content-type",n),l=null,"application/x-www-form-urlencoded"===n){l="";for(s in o)a=o[s],""!==l&&(l+="&"),l+=s+"="+encodeURIComponent(a)}"application/json"===n&&(l=JSON.stringify(o)),this.verbosity>=3&&console.log("BLOCKAPPS REQUEST:"),this.verbosity>=2&&console.log(c+" "+p+" - "+l+" - "+n);try{return null!=l&&""!==l?u.send(l):u.send()}catch(h){return i=h,r(i)}},l.prototype.requestTransactionResult=function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.requestTransactionResult"),e=this.strip0x(e),this.requestFromBlockApps("/transactionResult/"+e,function(e){return function(e,o){var n;return null!=e?void t(e):0===o.length?void t(null,null):(n=o[o.length-1],null!=n.message&&n.message.toLowerCase().indexOf("success")<0?void t(new Error(n.message)):t(null,n))}}(this))},l.prototype.requestTransactionData=function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.requestTransactionData"),e=this.strip0x(e),this.requestFromBlockApps("/transaction?hash="+e,function(o){return function(n,r){var i;return null!=n?void t(n):0===r.length?void t(null,null):(i=r[0],o.requestFromBlockApps("/block?number="+i.blockNumber,function(n,r){var l;return null!=n?void t(n):0===r.length?void t(null,null):(l=r[0],o.requestTransactionResult(e,function(e,o){return null!=e||null==o?void t(e,o):t(null,i,l,o)}))}))}}(this))},l.prototype.strip0x=function(e){return null==e?e:e.replace("0x","")},l.prototype.eth_coinbase=function(e){return null==this.coinbase?e(new Error("No coinbase specified in the BlockApps + Web3 provider!")):e(null,this.coinbase)},l.prototype.eth_accounts=function(e){return e(null,this.accounts)},l.prototype.eth_blockNumber=function(t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_blockNumber"),this.requestFromBlockApps("/block/last/1",function(o,n){var r;if(null!=o)return void t(o);if(0===n.length)throw new Error("Couldn't find last block at /block/last/1. Please make ensure BlockApps is running properly.");return r=n[0],t(null,e.fromDecimal(r.blockData.number))})},l.prototype.eth_getTransactionCount=function(e,t,o){null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/transaction?address="+e,function(e,t){return null!=e?void o(e):o(null,t.length)})},l.prototype.eth_getTransactionByHash=function(t,o){this.requestTransactionData(t,function(t,n,r,i){var l,s,c,u,a,p,h;if(null!=t)return void o(t);if(null==n||null==r||null==i)return void o();for(s=0,a=r.receiptTransactions,l=c=0,u=a.length;u>c;l=++c)if(h=a[l],h.r===n.r&&h.s===n.s&&h.v===n.v){s=l;break}return p={hash:"0x"+n.hash,nonce:e.fromDecimal(n.nonce),blockHash:"0x"+i.blockHash,blockNumber:e.fromDecimal(n.blockNumber),transactionIndex:e.fromDecimal(s),from:"0x"+n.from,gasPrice:e.fromDecimal(n.gasPrice),gas:e.fromDecimal(r.blockData.gasUsed),value:e.fromDecimal(n.value),input:"0x"+n.codeOrData},null!=n.to&&(p.to="0x"+n.to),o(null,p)})},l.prototype.eth_getBalance=function(e,t,o){null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/block?address="+e,function(e,t){return null!=e?void o(e):0===t.length?void o(null,0):void o(null,t[t.length-1].balance)})},l.prototype.eth_getCode=function(e,t,o){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getCode"),null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/account?address="+e,function(e,t){return null!=e?void o(e):0===t.length?void o():void o(null,"0x"+t[t.length-1].code)})},l.prototype.eth_getCompilers=function(e){e(null,["solidity"])},l.prototype.eth_compileSolidity=function(e,t){null==e&&(e=""),this.requestFromBlockApps("/solc",{src:e},function(o,n){var r,i,l,s,c,u,a;if(null!=o)return void t(o);for(a={},u=n.contracts,i=l=0,s=u.length;s>l;i=++l)r=u[i],c=r.name,a[c]={code:r.bin,info:{source:e,language:"Solidity",languageVersion:"0",compilerVersion:"0",abiDefinition:n.abis[i].abi,userDoc:{methods:{}},developerDoc:{methods:{}}}};t(null,a)})},l.prototype.eth_sendTransaction=function(t,o){return this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_sendTransaction"),null==t&&(t={}),null==t.from?void o(new Error("'from' not found, is required")):void this.requestFromBlockApps("/account?address="+this.strip0x(t.from),function(i){return function(l,s){var c,u,a;return null!=l?void o(l):(c=s.length>=1?s[s.length-1].nonce:0,u={nonce:e.fromDecimal(c),gasPrice:i.strip0x(e.fromDecimal(t.gasPrice||i.gasPrice)),gasLimit:i.strip0x(e.fromDecimal(t.gasLimit||19e5)),value:i.strip0x(e.fromDecimal(t.value||0)),data:"00"},null!=t.to&&(u.to=i.strip0x(t.to)),null!=t.data&&(u.data=i.strip0x(t.data)),u.from=i.strip0x(t.from),a=new n(u),i.keyprovider(u.from,function(e,t){var n,l;return null!=e?void o(e):(n=new r(i.strip0x(t),"hex"),a.sign(n),l=a.serialize().toString("hex"),i.eth_sendRawTransaction(l,o))}))}}(this))},l.prototype.eth_sendRawTransaction=function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_sendRawTransaction");var l,s,c,u;u=new n(new r(e,"hex")),o.config({EXPONENTIAL_AT:2e7}),c=u.value.toString("hex"),l=new o(0),""!==c&&(l=new o(c,16)),s={from:u.getSenderAddress().toString("hex"),nonce:i.bufferToInt(u.nonce),gasPrice:i.bufferToInt(u.gasPrice),gasLimit:i.bufferToInt(u.gasLimit),value:l.toString(),codeOrData:u.data.toString("hex"),r:u.r.toString("hex"),s:u.s.toString("hex"),v:u.v.toString("hex"),hash:u.hash().toString("hex")},0!==u.to.length&&(s.to=u.to.toString("hex")),this.requestFromBlockApps("/transaction",s,"application/json",function(e,o){var n;return n="0x"+o.replace(/.*=/,""),t(null,n)})},l.prototype.eth_call=function(t,o,n){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_call"),null==t&&(t={}),null==o&&(o="latest"),this.eth_sendTransaction(t,function(t){return function(o,r){var i,l,s,c;return null!=o?void n(o):(r=t.strip0x(r),l=0,c=5,s=null,i=function(){return l+=1,t.requestTransactionResult(r,function(t,o){return null!=t?void n(t,o):(null!=o&&null!=o.response&&(clearInterval(s),n(null,e.toHex(o.response))),l>=c?(clearInterval(s),n("Couldn't get call() return value after "+l+" attempts.")):void 0)})},s=setInterval(i,1e3),i())}}(this))},l.prototype.eth_getTransactionReceipt=function(t,o){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getTransactionReceipt"),this.requestTransactionData(t,function(t,n,r,l){var s,c,u,a,p,h,d,v;if(null!=t)return void o(t);if(null==n||null==r||null==l)return void o(null,null);for(u=0,h=r.receiptTransactions,c=a=0,p=h.length;p>a;c=++a)if(v=h[c],v.r===n.r&&v.s===n.s&&v.v===n.v){u=c;break}return d={blockNumber:e.fromDecimal(n.blockNumber),transactionHash:"0x"+n.hash,transactionIndex:e.fromDecimal(u),from:"0x"+n.from,cumulativeGasUsed:e.fromDecimal(r.blockData.gasUsed),gasUsed:e.fromDecimal(0),logs:[]},null!=n.to&&(d.to="0x"+n.to),s=i.generateAddress(n.from,parseInt(n.nonce+1)).toString("hex"),l.trace.indexOf(s)?(d.blockHash="0x"+l.blockHash,d.contractAddress="0x"+s,o(t,d)):void o(null,null)})},l.prototype.eth_newBlockFilter=function(t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_newBlockFilter");var o=this,n=new s(this);n.initialize(function(r){return null!=r?void t(r):(o.filter_index+=1,o.filters[o.filter_index]=n,void t(null,e.fromDecimal(o.filter_index)))})},l.prototype.eth_uninstallFilter=function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_uninstallFilter"),t(null,!0)},l.prototype.eth_getFilterChanges=function(t,o){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getFilterChanges");var n;return t=e.toDecimal(t),n=this.filters[t],null==n?void o(null,[]):n.getChanges(o)},l.prototype.eth_gasPrice=function(t){this.provider.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_gasPrice"),this.requestFromBlockApps("/transaction/last/1",function(o,n){var r;return null!=o?void t(o):0===n.length?void t(new Error("Could not determine current gasPrice!")):(r=n[0],t(null,e.fromDecimal(r.gasPrice)))})},l.prototype.web3_clientVersion=function(e){return e(null,"BlockApps Web3 Provider/0.0.1/JavaScript")},l}()},"undefined"!=typeof module&&null!==module&&null!=module.exports?(EthTx=require("ethereumjs-tx"),module.exports=factory(require("web3"),require("xhr2"),require("bignumber.js"),EthTx,Buffer,ethUtil)):window.BlockAppsWeb3Provider=factory(window.web3,window.XMLHttpRequest,window.BigNumber,window.EthTx,window.Buffer,window.ethUtil);