/*! blockapps-web3 15-07-2015 */
(function(){var a,b;b=function(a,b,c,d,e,f){var g,h;return h=function(){function b(b){this.provider=b,this.provider.eth_blockNumber(function(b){return function(c,d){if(null!=c)throw c;return b.block_number=a.toDecimal(d)}}(this))}return b.prototype.getChanges=function(b){return this.provider.eth_blockNumber(function(c){return function(d,e){return null!=d?void b(d):(e=a.toDecimal(e),c.getBlockHashesRecursively([],c.block_number,e,function(a,c){return null!=a?void b(a):b(null,c)}))}}(this))},b.prototype.getBlockHashesRecursively=function(a,b,c,d){return this.getBlockHash(b,function(e){return function(f,g){return null!=f?void d(f):(null!=g&&a.push(g),b>=c||null==g?void d(null,a):e.getBlockHashesRecursively(a,b+1,c,d))}}(this))},b.prototype.getBlockHash=function(a,b){return this.provider.requestFromBlockApps("/query/block?number="+a,function(a){return function(a,c){var d;return null!=a?void b(a):0===c.length?void b():(d=c[0],b(null,"0x"+d.blockData.parentHash))}}(this))},b}(),g=function(){function g(a){null==a&&(a={}),this.coinbase=a.coinbase,this.accounts=a.accounts||[],this.host=a.host||"http://stablenet.blockapps.net",this.verbose=a.verbose||!1,this.gasPrice=a.gasPrice||1e12,this.keyprovider=a.keyprovider||function(){throw new Error("No key provider given to BlockApps + Web3. Can't send transaction.")},this.filter_index=0,this.filters={}}return g.prototype.send=function(a){throw new Error("BlockAppsWeb3Provider does not support synchronous methods. Please provide a callback.")},g.prototype.sendAsync=function(a,b){return a instanceof Array?this.processBatchRequest(a,b):this.processSingleRequest(a,b)},g.prototype.processSingleRequest=function(a,b){var c,d,e,f,g,h,i;if(g=a.method,null==this[g])throw new Error("BlockAppsWeb3Provider does not yet support the Web3 method '"+g+"'.");for(c=[],i=a.params||[],e=0,f=i.length;f>e;e++)h=i[e],c.push(h);return c.push(function(c,d){var e;return e={id:a.id,jsonrpc:a.jsonrpc,result:d},b(c,e)}),d=this[g],d.length!==c.length?void b(new Error("Invalid number of parameters passed to "+g)):d.apply(this,c)},g.prototype.processBatchRequest=function(a,b){var c,d,e;return c=-1,e=[],(d=function(f){return function(){return c+=1,f.processSingleRequest(a[c],function(f,g){return null!=f?void b(f):(e.push(g),c>=a.length-1?void b(null,e):d())})}}(this))()},g.prototype.requestFromBlockApps=function(a,c,d,e){var f,g,h,i,j,k;if("function"==typeof c&&(e=c,c=null,d="application/x-www-form-urlencoded"),"function"==typeof d&&(e=d,d="application/x-www-form-urlencoded"),j=new b,j.onreadystatechange=function(a){return function(){var b,c,d,f;if(4===j.readyState){d=j.responseText,c=null;try{d=JSON.parse(d)}catch(g){b=g,c=b}a.verbose&&(f=d,"string"!=typeof f&&(f=JSON.stringify(f,null,2)),console.log("BLOCKAPPS RESPONSE:\n"+f+"\n")),e(c,d)}}}(this),i=null!=c?"POST":"GET",j.open(i,""+this.host+a,!0),j.setRequestHeader("Content-type",d),g=null,"application/x-www-form-urlencoded"===d){g="";for(h in c)k=c[h],""!==g&&(g+="&"),g+=h+"="+encodeURIComponent(k)}"application/json"===d&&(g=JSON.stringify(c)),this.verbose&&console.log("BLOCKAPPS REQUEST:\n"+i+" "+this.host+a+" - "+g+" - "+d+"\n");try{return null!=g&&""!==g?j.send(g):j.send()}catch(l){return f=l,e(f)}},g.prototype.requestTransactionResult=function(a,b){return a=this.strip0x(a),this.requestFromBlockApps("/transactionResult/"+a,function(a){return function(a,c){var d;return null!=a?void b(a):0===c.length?void b(null,null):(d=c[c.length-1],null!=d.message&&d.message.toLowerCase().indexOf("success")<0?void b(new Error(d.message)):b(null,d))}}(this))},g.prototype.requestTransactionData=function(a,b){return a=this.strip0x(a),this.requestFromBlockApps("/query/transaction?hash="+a,function(c){return function(d,e){var f;return null!=d?void b(d):0===e.length?void b(null,null):(f=e[0],c.requestFromBlockApps("/query/block?number="+f.blockNumber,function(d,e){var g;return null!=d?void b(d):0===e.length?void b(null,null):(g=e[0],c.requestTransactionResult(a,function(a,c){return null!=a||null==c?void b(a,c):b(null,f,g,c)}))}))}}(this))},g.prototype.strip0x=function(a){return null==a?a:a.replace("0x","")},g.prototype.eth_coinbase=function(a){return null==this.coinbase?a(new Error("No coinbase specified in the BlockApps + Web3 provider!")):a(null,this.coinbase)},g.prototype.eth_accounts=function(a){return a(null,this.accounts)},g.prototype.eth_blockNumber=function(b){return this.requestFromBlockApps("/query/block/last/1",function(c,d){var e;if(null!=c)return void b(c);if(0===d.length)throw new Error("Couldn't find last block at /query/block/last/1. Please make ensure BlockApps is running properly.");return e=d[0],b(null,a.fromDecimal(e.blockData.number))})},g.prototype.eth_getTransactionCount=function(a,b,c){return null==b&&(b="latest"),a=this.strip0x(a),this.requestFromBlockApps("/query/transaction?address="+a,function(a,b){return null!=a?void c(a):c(null,b.length)})},g.prototype.eth_getTransactionByHash=function(b,c){return this.requestTransactionData(b,function(b,d,e,f){var g,h,i,j,k,l,m;if(null!=b)return void c(b);if(null==d||null==e||null==f)return void c();for(h=0,k=e.receiptTransactions,g=i=0,j=k.length;j>i;g=++i)if(m=k[g],m.r===d.r&&m.s===d.s&&m.v===d.v){h=g;break}return l={hash:"0x"+d.hash,nonce:a.fromDecimal(d.nonce),blockHash:"0x"+f.blockHash,blockNumber:a.fromDecimal(d.blockNumber),transactionIndex:a.fromDecimal(h),from:"0x"+d.from,gasPrice:a.fromDecimal(d.gasPrice),gas:a.fromDecimal(e.blockData.gasUsed),value:a.fromDecimal(d.value),input:"0x"+d.codeOrData},null!=d.to&&(l.to="0x"+d.to),c(null,l)})},g.prototype.eth_getBalance=function(a,b,c){return null==b&&(b="latest"),a=this.strip0x(a),this.requestFromBlockApps("/query/block?address="+a,function(a,b){return null!=a?void c(a):0===b.length?void c(null,0):c(null,b[b.length-1].balance)})},g.prototype.eth_getCode=function(a,b,c){return null==b&&(b="latest"),a=this.strip0x(a),this.requestFromBlockApps("/query/account?address="+a,function(a,b){return null!=a?void c(a):0===b.length?void c():c(null,"0x"+b[b.length-1].code)})},g.prototype.eth_getCompilers=function(a){return a(null,["solidity"])},g.prototype.eth_compileSolidity=function(a,b){return null==a&&(a=""),this.requestFromBlockApps("/solc",{src:a},function(c,d){var e,f,g,h,i,j,k;if(null!=c)return void b(c);for(k={},j=d.contracts,f=g=0,h=j.length;h>g;f=++g)e=j[f],i=e.name,k[i]={code:e.bin,info:{source:a,language:"Solidity",languageVersion:"0",compilerVersion:"0",abiDefinition:d.abis[f].abi,userDoc:{methods:{}},developerDoc:{methods:{}}}};return b(null,k)})},g.prototype.eth_sendTransaction=function(b,c){return null==b&&(b={}),null==b.from?void c(new Error("'from' not found, is required")):this.requestFromBlockApps("/query/account?address="+this.strip0x(b.from),function(f){return function(g,h){var i,j,k;return null!=g?void c(g):(i=h.length>=1?h[h.length-1].nonce:0,j={nonce:a.fromDecimal(i),gasPrice:f.strip0x(a.fromDecimal(b.gasPrice||f.gasPrice)),gasLimit:f.strip0x(a.fromDecimal(b.gasLimit||19e5)),value:f.strip0x(a.fromDecimal(b.value||0)),data:"00"},null!=b.to&&(j.to=f.strip0x(b.to)),null!=b.data&&(j.data=f.strip0x(b.data)),j.from=f.strip0x(b.from),k=new d(j),f.keyprovider(j.from,function(a,b){var d,g;return null!=a?void c(a):(d=new e(f.strip0x(b),"hex"),k.sign(d),g=k.serialize().toString("hex"),f.eth_sendRawTransaction(g,c))}))}}(this))},g.prototype.eth_sendRawTransaction=function(a,b){var g,h,i,j;return j=new d(new e(a,"hex")),c.config({EXPONENTIAL_AT:2e7}),i=j.value.toString("hex"),g=new c(0),""!==i&&(g=new c(i,16)),h={from:j.getSenderAddress().toString("hex"),nonce:f.bufferToInt(j.nonce),gasPrice:f.bufferToInt(j.gasPrice),gasLimit:f.bufferToInt(j.gasLimit),value:g.toString(),codeOrData:j.data.toString("hex"),r:j.r.toString("hex"),s:j.s.toString("hex"),v:j.v.toString("hex"),hash:j.hash().toString("hex")},0!==j.to.length&&(h.to=j.to.toString("hex")),this.requestFromBlockApps("/includetransaction",h,"application/json",function(a,c){var d;return d="0x"+c.replace(/.*=/,""),b(null,d)})},g.prototype.eth_call=function(b,c,d){return null==b&&(b={}),null==c&&(c="latest"),this.eth_sendTransaction(b,function(b){return function(c,e){var f,g,h,i;return null!=c?void d(c):(e=b.strip0x(e),g=0,i=5,h=null,f=function(){return g+=1,b.requestTransactionResult(e,function(b,c){return null!=b?void d(b,c):(null!=c&&null!=c.response&&(clearInterval(h),d(null,a.toHex(c.response))),g>=i?(clearInterval(h),d("Couldn't get call() return value after "+g+" attempts.")):void 0)})},h=setInterval(f,1e3),f())}}(this))},g.prototype.eth_getTransactionReceipt=function(b,c){return this.requestTransactionData(b,function(b,d,e,g){var h,i,j,k,l,m,n,o;if(null!=b)return void c(b);if(null==d||null==e||null==g)return void c(null,null);for(j=0,m=e.receiptTransactions,i=k=0,l=m.length;l>k;i=++k)if(o=m[i],o.r===d.r&&o.s===d.s&&o.v===d.v){j=i;break}return n={blockNumber:a.fromDecimal(d.blockNumber),transactionHash:"0x"+d.hash,transactionIndex:a.fromDecimal(j),from:"0x"+d.from,cumulativeGasUsed:a.fromDecimal(e.blockData.gasUsed),gasUsed:a.fromDecimal(0),logs:[]},null!=d.to&&(n.to="0x"+d.to),h=f.generateAddress(d.from,parseInt(d.nonce+1)).toString("hex"),g.trace.indexOf(h)?(n.blockHash="0x"+g.blockHash,n.contractAddress="0x"+h,c(b,n)):void c(null,null)})},g.prototype.eth_newBlockFilter=function(b){var c;return c=new h(this),this.filter_index+=1,this.filters[this.filter_index]=c,b(null,a.fromDecimal(this.filter_index))},g.prototype.eth_uninstallFilter=function(b,c){var d;return b=a.toDecimal(b),d=this.filters[b],null==d?void c(null,!1):(delete this.filters[b],c(null,!0))},g.prototype.eth_getFilterChanges=function(b,c){var d;return b=a.toDecimal(b),d=this.filters[b],null==d?void c(null,[]):d.getChanges(c)},g.prototype.eth_gasPrice=function(b){return this.requestFromBlockApps("/query/transaction/last/1",function(c,d){var e;return null!=c?void b(c):0===d.length?void b(new Error("Could not determine current gasPrice!")):(e=d[0],b(null,a.fromDecimal(e.gasPrice)))})},g.prototype.web3_clientVersion=function(a){return a(null,"BlockApps Web3 Provider/0.0.1/JavaScript")},g}()},"undefined"!=typeof module&&null!==module&&null!=module.exports?(a=require("ethereumjs-tx"),module.exports=b(require("web3"),require("xhr2"),require("bignumber.js"),a,Buffer,ethUtil)):window.BlockAppsWeb3Provider=b(window.web3,window.XMLHttpRequest,window.BigNumber,window.EthTx,window.Buffer,window.ethUtil)}).call(this);