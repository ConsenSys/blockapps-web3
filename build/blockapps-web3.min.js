"use strict";function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,l=e[Symbol.iterator]();!(r=(s=l.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(a){o=!0,i=a}finally{try{!r&&l["return"]&&l["return"]()}finally{if(o)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_get=function(e,t,n){for(var r=!0;r;){var o=e,i=t,s=n;l=c=a=void 0,r=!1,null===o&&(o=Function.prototype);var l=Object.getOwnPropertyDescriptor(o,i);if(void 0!==l){if("value"in l)return l.value;var a=l.get;return void 0===a?void 0:a.call(s)}var c=Object.getPrototypeOf(o);if(null===c)return void 0;e=c,t=i,n=s,r=!0}},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),EthTx,factory=function(e,t,n,r,o,i,s,l){function a(e){var t=u(e),n=t.toString(16);return t.lessThan(0)?"-0x"+n.substr(1):"0x"+n}function c(e){return u(e).toNumber()}function u(e){return e=e||0,h(e)?e:!v(e)||0!==e.indexOf("0x")&&0!==e.indexOf("-0x")?new o(e.toString(10),10):new o(e.replace("0x",""),16)}function h(e){return e instanceof o||e&&e.constructor&&"BigNumber"===e.constructor.name}function v(e){return"string"==typeof e||e&&e.constructor&&"String"===e.constructor.name}e.shim();var f=function(){function e(t){_classCallCheck(this,e),this.provider=t}return _createClass(e,[{key:"initialize",value:function(e){this.provider.verbosity>=1&&console.log("   BlockFilter.initialize");var t=this;this.provider.eth_blockNumber(function(n,r){return null!=n?void e(n):(t.block_number=c(r),void e())})}},{key:"getChanges",value:function(e){this.provider.verbosity>=1&&console.log("   BlockFilter.getChanges");var t=this;this.provider.eth_blockNumber(function(n,r){return null!=n?void e(n):(r=c(r),void t.getBlockHashesRecursively([],t.block_number,r+1,e))})}},{key:"getBlockHashesRecursively",value:function(e,t,n,r){this.provider.verbosity>=1&&console.log("   BlockFilter.getBlockHashesRecursively");var o=this;this.getBlockHash(t,function(i,s){return null!=i?void r(i):(null!=s&&e.push(s),t>=n||null==s?void r(null,e):void o.getBlockHashesRecursively(e,t+1,n,r))})}},{key:"getBlockHash",value:function(e,t){this.provider.verbosity>=1&&console.log("   BlockFilter.getBlockHash"),this.provider.requestFromBlockApps("/block?number="+e,function(e){return function(e,n){var r;return null!=e?void t(e):0===n.length?void t():(r=n[0],void t(null,"0x"+r.blockData.parentHash))}}(this))}}]),e}(),p=function(e){function t(e){_classCallCheck(this,t),null==e&&(e={}),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,{host:e.host,transaction_signer:e.transaction_signer}),this.coinbase=e.coinbase,this.coinbase.indexOf("0x")<0&&(this.coinbase="0x"+this.coinbase),this.accounts=e.accounts||[];var n=!0,r=!1,o=void 0;try{for(var i,s=Object.entries(this.accounts)[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var l=_slicedToArray(i.value,2),a=l[0],c=l[1];c.indexOf("0x")<0&&(this.accounts[a]="0x"+c)}}catch(u){r=!0,o=u}finally{try{!n&&s["return"]&&s["return"]()}finally{if(r)throw o}}this.host=e.host||"http://hacknet.blockapps.net",this.version=e.version||"v1.0",this.blockchain=e.blockchain||"eth",this.verbosity=e.verbosity||0,this.gasPrice=e.gasPrice||1e12,this.transaction_signer=e.transaction_signer||function(){throw new Error("No key provider given to BlockApps + Web3. Can't send transaction.")},this.filter_index=0,this.filters={}}return _inherits(t,e),_createClass(t,[{key:"send",value:function(e){switch(e.method){case"eth_accounts":var t={id:e.id,jsonrpc:e.jsonrpc,result:this.accounts};return t}throw new Error("BlockAppsWeb3Provider does not support synchronous methods. Please provide a callback.")}},{key:"sendAsync",value:function(e,t){var n=this,r=function(r){return null!=r?t(r):void(e instanceof Array?n.processBatchRequest(e,t):n.processSingleRequest(e,t))},o=e;e instanceof Array||(o=[e]),this.rewritePayloads(0,o,{},r)}},{key:"processSingleRequest",value:function(e,t){var n=e.method;if(null==this[n])return void t(new Error("BlockAppsWeb3Provider does not yet support the Web3 method '"+n+"'."));for(var r=[],o=e.params||[],i=0;i<o.length;i++)r.push(o[i]);r.push(function(n,r){var o={id:e.id,jsonrpc:e.jsonrpc};null!=n?o.error=n.stack:o.result=r,t(null,o)});var s=this[n];return s.length!==r.length?void t(new Error("Invalid number of parameters passed to "+n)):void s.apply(this,r)}},{key:"processBatchRequest",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.processBatchRequest");for(var n=[],r=0;r<e.length;r++)n.push(e[r]);if(this.verbosity>=1){for(var o="batch start: ",r=0;r<e.length;r++)o+=e[r].method+" ";console.log(o)}this.makeBatchRequests(0,n,[],t)}},{key:"makeBatchRequests",value:function(e,t,n,r){var o=this;return e>=t.length?r(null,n):void this.processSingleRequest(t[e],function(i,s){n.push(s),o.makeBatchRequests(e+1,t,n,r)})}},{key:"requestFromBlockApps",value:function(e,t,n,o){var i,s,l,a,c,u;"function"==typeof t&&(o=t,t=null,n="application/x-www-form-urlencoded"),"function"==typeof n&&(o=n,n="application/x-www-form-urlencoded"),c=new r,c.onreadystatechange=function(e){return function(){var t,n,r,i;if(4===c.readyState){r=c.responseText,n=null;try{r=JSON.parse(r)}catch(s){t=s,n=t}e.verbosity>=3&&(i=r,"string"!=typeof i&&(i=JSON.stringify(i,null,2)),console.log("BLOCKAPPS RESPONSE:\n"+h+"\n\n"+i+"\n")),o(n,r)}}}(this),a=null!=t?"POST":"GET";var h=this.host+"/"+this.blockchain+"/"+this.version+e;if(c.open(a,h,!0),c.setRequestHeader("Content-type",n),s=null,"application/x-www-form-urlencoded"===n){s="";for(l in t)u=t[l],""!==s&&(s+="&"),s+=l+"="+encodeURIComponent(u)}"application/json"===n&&(s=JSON.stringify(t)),this.verbosity>=3&&console.log("BLOCKAPPS REQUEST:"),this.verbosity>=2&&console.log(a+" "+h+" - "+s+" - "+n);try{return null!=s&&""!==s?c.send(s):c.send()}catch(v){return i=v,o(i)}}},{key:"requestTransactionResult",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.requestTransactionResult"),e=this.strip0x(e),this.requestFromBlockApps("/transactionResult/"+e,function(e){return function(e,n){var r;return null!=e?void t(e):0===n.length?void t(null,null):(r=n[n.length-1],null!=r.message&&r.message.toLowerCase().indexOf("success")<0?void t(new Error(r.message)):t(null,r))}}(this))}},{key:"requestTransactionData",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.requestTransactionData"),e=this.strip0x(e),this.requestFromBlockApps("/transaction?hash="+e,function(n){return function(r,o){var i;return null!=r?void t(r):0===o.length?void t(null,null):(i=o[0],n.requestFromBlockApps("/block?number="+i.blockNumber,function(r,o){var s;return null!=r?void t(r):0===o.length?void t(null,null):(s=o[0],n.requestTransactionResult(e,function(e,n){return null!=e||null==n?void t(e,n):t(null,i,s,n)}))}))}}(this))}},{key:"strip0x",value:function(e){return null==e?e:e.replace("0x","")}},{key:"eth_coinbase",value:function(e){return null==this.coinbase?e(new Error("No coinbase specified in the BlockApps + Web3 provider!")):e(null,this.coinbase)}},{key:"eth_accounts",value:function(e){return e(null,this.accounts)}},{key:"eth_blockNumber",value:function(e){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_blockNumber"),this.requestFromBlockApps("/block/last/1",function(t,n){var r;if(null!=t)return void e(t);if(0===n.length)throw new Error("Couldn't find last block at /block/last/1. Please make ensure BlockApps is running properly.");return r=n[0],e(null,a(r.blockData.number))})}},{key:"eth_getBlockByNumber",value:function(e,t,n){"function"==typeof t&&(n=t,t=!1);var r=new o(e,16);this.requestFromBlockApps("/block?number="+r.toString(10),function(e,r){if(null!=e)return n(e);var o=r[r.length-1],i=o.blockData,s={number:a(i.number),hash:"0x"+i.parentHash,parentHash:"0x"+i.parentHash,nonce:a(i.nonce),sha3Uncles:"0x"+i.unclesHash,logsBloom:"0x0",transactionsRoot:"0x"+i.transactionsRoot,stateRoot:"0x"+i.stateRoot,miner:"0x0",difficulty:a(i.difficulty),totalDifficulty:a(i.difficulty),extraData:"0x"+i.extraData,size:"0x0",gasLimit:a(i.gasLimit),gasUsed:a(i.gasUsed),timestamp:a(new Date(i.timestamp).getTime())};1==t?s.transactions=o.receiptTransactions:s.transactions=o.receiptTransactions.map(function(e){return"0x"+e.hash}),s.uncles=o.blockUncles.map(function(e){return"0x"+e.hash}),n(null,s)})}},{key:"eth_getTransactionCount",value:function(e,t,n){null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/account?address="+e,function(e,t){if(null!=e)return void n(e);var r;if(t.length){var o=t[t.length-1];r=a(o.nonce)}else r="0x00";return n(null,r)})}},{key:"eth_getTransactionByHash",value:function(e,t){this.requestTransactionData(e,function(e,n,r,o){var i,s,l,c,u,h,v;if(null!=e)return void t(e);if(null==n||null==r||null==o)return void t();for(s=0,u=r.receiptTransactions,i=l=0,c=u.length;c>l;i=++l)if(v=u[i],v.r===n.r&&v.s===n.s&&v.v===n.v){s=i;break}return h={hash:"0x"+n.hash,nonce:a(n.nonce),blockHash:"0x"+o.blockHash,blockNumber:a(n.blockNumber),transactionIndex:a(s),from:"0x"+n.from,gasPrice:a(n.gasPrice),gas:a(r.blockData.gasUsed),value:a(n.value),input:"0x"+n.codeOrData},null!=n.to&&(h.to="0x"+n.to),t(null,h)})}},{key:"eth_getBalance",value:function(e,t,n){null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/account?address="+e,function(e,t){if(null!=e)return void n(e);if(0===t.length)return void n(null,"0x0");var r=new o(t[t.length-1].balance);n(null,"0x"+r.toString(16))})}},{key:"eth_getCode",value:function(e,t,n){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getCode"),null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/account?address="+e,function(e,t){return null!=e?void n(e):0===t.length?void n():void n(null,"0x"+t[t.length-1].code)})}},{key:"eth_getCompilers",value:function(e){e(null,["solidity"])}},{key:"eth_compileSolidity",value:function(e,t){null==e&&(e=""),this.requestFromBlockApps("/solc",{src:e},function(n,r){var o,i,s,l,a,c,u;if(null!=n)return void t(n);if(null!=r.error)return void t(new Error(r.error));for(u={},c=r.contracts,i=s=0,l=c.length;l>s;i=++s)o=c[i],a=o.name,u[a]={code:o.bin,info:{source:e,language:"Solidity",languageVersion:"0",compilerVersion:"0",abiDefinition:r.abis[i].abi,userDoc:{methods:{}},developerDoc:{methods:{}}}};t(null,u)})}},{key:"eth_sendTransaction",value:function(e,t){return t(new Error("BlockAppsWeb3 provider can't send transactions from addresses that aren't managed by the transaction signer. Make sure your transaction signer manages this account before sendint a transaction. Account: "+e.from))}},{key:"eth_sendRawTransaction",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_sendRawTransaction"),e=this.strip0x(e);var n=new i(new s(e,"hex"));o.config({EXPONENTIAL_AT:2e7});var r=n.value.toString("hex"),a=new o(0);""!==r&&(a=new o(r,16));var c={from:n.getSenderAddress().toString("hex"),nonce:l.bufferToInt(n.nonce),gasPrice:l.bufferToInt(n.gasPrice),gasLimit:l.bufferToInt(n.gasLimit),value:a.toString(),codeOrData:n.data.toString("hex"),r:n.r.toString("hex"),s:n.s.toString("hex"),v:n.v.toString("hex"),hash:n.hash().toString("hex")};0!==n.to.length&&(c.to=n.to.toString("hex")),this.requestFromBlockApps("/transaction",c,"application/json",function(e,n){var r;return r="0x"+n.replace(/.*=/,""),t(null,r)})}},{key:"eth_call",value:function(e,t,r){function o(e,t){if(e)return r(e);var n=void 0;t&&t.vm["return"]&&(n="0x"+t.vm["return"].toString("hex")),r(null,n)}this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_call");var a=this.host+"/"+this.blockchain+"/"+this.version+"/",c=n({url:a}),u=new i({to:e.to,nonce:e.nonce||"0x00",gasPrice:e.gasPrice||"0x01",gasLimit:e.gas||"0xffffff",value:e.value||"0x00",data:e.data||"0x"}),h=e.from||this.accounts[0];u.from=new s(l.stripHexPrefix(h),"hex"),c.stateManager.checkpoint(),c.runTx({tx:u,skipNonce:!0},o)}},{key:"eth_getTransactionReceipt",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getTransactionReceipt"),this.requestTransactionData(e,function(e,n,r,o){var i,s,c,u,h,v,f,p;if(null!=e)return void t(e);if(null==n||null==r||null==o)return void t(null,null);for(c=0,v=r.receiptTransactions,s=u=0,h=v.length;h>u;s=++u)if(p=v[s],p.r===n.r&&p.s===n.s&&p.v===n.v){c=s;break}return f={blockNumber:a(n.blockNumber),transactionHash:"0x"+n.hash,transactionIndex:a(c),from:"0x"+n.from,cumulativeGasUsed:a(r.blockData.gasUsed),gasUsed:a(0),logs:[]},null!=n.to&&(f.to="0x"+n.to),i=l.generateAddress(n.from,parseInt(n.nonce)).toString("hex"),o.trace.indexOf(i)?(f.blockHash="0x"+o.blockHash,f.contractAddress="0x"+i,t(e,f)):void t(null,null)})}},{key:"eth_newBlockFilter",value:function(e){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_newBlockFilter");var t=this,n=new f(this);n.initialize(function(r){return null!=r?void e(r):(t.filter_index+=1,t.filters[t.filter_index]=n,void e(null,a(t.filter_index)))})}},{key:"eth_uninstallFilter",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_uninstallFilter"),t(null,!0)}},{key:"eth_getFilterChanges",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getFilterChanges");var n;return e=c(e),n=this.filters[e],null==n?void t(null,[]):n.getChanges(t)}},{key:"eth_gasPrice",value:function(e){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_gasPrice"),this.requestFromBlockApps("/transaction/last/1",function(t,n){var r;return null!=t?void e(t):0===n.length?void e(new Error("Could not determine current gasPrice!")):(r=n[0],e(null,a(r.gasPrice)))})}},{key:"web3_clientVersion",value:function(e){return e(null,"BlockApps Web3 Provider/0.0.1/JavaScript")}}]),t}(t);return p};"undefined"!=typeof module?(EthTx=require("ethereumjs-tx"),module.exports=factory(require("object.entries"),require("hooked-web3-provider"),require("blockapps-vm"),require("xhr2"),require("bignumber.js"),EthTx,Buffer,ethUtil)):window.BlockAppsWeb3Provider=factory(window.ObjectEntries,window.HookedWeb3Provider,window.BlockAppsVm,window.XMLHttpRequest,window.BigNumber,window.EthTx,window.Buffer,window.ethUtil);