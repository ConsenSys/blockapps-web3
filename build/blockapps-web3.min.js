"use strict";function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,l=e[Symbol.iterator]();!(r=(s=l.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(a){o=!0,i=a}finally{try{!r&&l["return"]&&l["return"]()}finally{if(o)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_get=function(e,t,n){for(var r=!0;r;){var o=e,i=t,s=n;l=c=a=void 0,r=!1,null===o&&(o=Function.prototype);var l=Object.getOwnPropertyDescriptor(o,i);if(void 0!==l){if("value"in l)return l.value;var a=l.get;return void 0===a?void 0:a.call(s)}var c=Object.getPrototypeOf(o);if(null===c)return void 0;e=c,t=i,n=s,r=!0}},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),EthTx,factory=function(e,t,n,r,o,i,s,l){var a=function(){function t(e){_classCallCheck(this,t),this.provider=e}return _createClass(t,[{key:"initialize",value:function(t){this.provider.verbosity>=1&&console.log("   BlockFilter.initialize");var n=this;this.provider.eth_blockNumber(function(r,o){return null!=r?void t(r):(n.block_number=e.toDecimal(o),void t())})}},{key:"getChanges",value:function(t){this.provider.verbosity>=1&&console.log("   BlockFilter.getChanges");var n=this;this.provider.eth_blockNumber(function(r,o){return null!=r?void t(r):(o=e.toDecimal(o),void n.getBlockHashesRecursively([],n.block_number,o+1,t))})}},{key:"getBlockHashesRecursively",value:function(e,t,n,r){this.provider.verbosity>=1&&console.log("   BlockFilter.getBlockHashesRecursively");var o=this;this.getBlockHash(t,function(i,s){return null!=i?void r(i):(null!=s&&e.push(s),t>=n||null==s?void r(null,e):void o.getBlockHashesRecursively(e,t+1,n,r))})}},{key:"getBlockHash",value:function(e,t){this.provider.verbosity>=1&&console.log("   BlockFilter.getBlockHash"),this.provider.requestFromBlockApps("/block?number="+e,function(e){return function(e,n){var r;return null!=e?void t(e):0===n.length?void t():(r=n[0],void t(null,"0x"+r.blockData.parentHash))}}(this))}}]),t}(),c=function(t){function c(e){_classCallCheck(this,c),null==e&&(e={}),_get(Object.getPrototypeOf(c.prototype),"constructor",this).call(this,{host:e.host,transaction_signer:e.transaction_signer}),this.coinbase=e.coinbase,this.coinbase.indexOf("0x")<0&&(this.coinbase="0x"+this.coinbase),this.accounts=e.accounts||[];var t=!0,n=!1,r=void 0;try{for(var o,i=Object.entries(this.accounts)[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var s=_slicedToArray(o.value,2),l=s[0],a=s[1];a.indexOf("0x")<0&&(this.accounts[l]="0x"+a)}}catch(u){n=!0,r=u}finally{try{!t&&i["return"]&&i["return"]()}finally{if(n)throw r}}this.host=e.host||"http://hacknet.blockapps.net",this.version=e.version||"v1.0",this.blockchain=e.blockchain||"eth",this.verbosity=e.verbosity||0,this.gasPrice=e.gasPrice||1e12,this.transaction_signer=e.transaction_signer||function(){throw new Error("No key provider given to BlockApps + Web3. Can't send transaction.")},this.filter_index=0,this.filters={}}return _inherits(c,t),_createClass(c,[{key:"send",value:function(e){switch(e.method){case"eth_accounts":var t={id:e.id,jsonrpc:e.jsonrpc,result:this.accounts};return t}throw new Error("BlockAppsWeb3Provider does not support synchronous methods. Please provide a callback.")}},{key:"sendAsync",value:function(e,t){var n=this,r=function(r){return null!=r?t(r):void(e instanceof Array?n.processBatchRequest(e,t):n.processSingleRequest(e,t))},o=e;e instanceof Array||(o=[e]),this.rewritePayloads(0,o,{},r)}},{key:"processSingleRequest",value:function(e,t){var n=e.method;if(null==this[n])return void t(new Error("BlockAppsWeb3Provider does not yet support the Web3 method '"+n+"'."));for(var r=[],o=e.params||[],i=0;i<o.length;i++)r.push(o[i]);r.push(function(n,r){var o={id:e.id,jsonrpc:e.jsonrpc};null!=n?o.error=n.stack:o.result=r,t(null,o)});var s=this[n];return s.length!==r.length?void t(new Error("Invalid number of parameters passed to "+n)):void s.apply(this,r)}},{key:"processBatchRequest",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.processBatchRequest");for(var n=[],r=0;r<e.length;r++)n.push(e[r]);if(this.verbosity>=1){for(var o="batch start: ",r=0;r<e.length;r++)o+=e[r].method+" ";console.log(o)}this.makeBatchRequests(0,n,[],t)}},{key:"makeBatchRequests",value:function(e,t,n,r){var o=this;return e>=t.length?r(null,n):void this.processSingleRequest(t[e],function(i,s){n.push(s),o.makeBatchRequests(e+1,t,n,r)})}},{key:"requestFromBlockApps",value:function(e,t,n,o){var i,s,l,a,c,u;"function"==typeof t&&(o=t,t=null,n="application/x-www-form-urlencoded"),"function"==typeof n&&(o=n,n="application/x-www-form-urlencoded"),c=new r,c.onreadystatechange=function(e){return function(){var t,n,r,i;if(4===c.readyState){r=c.responseText,n=null;try{r=JSON.parse(r)}catch(s){t=s,n=t}e.verbosity>=3&&(i=r,"string"!=typeof i&&(i=JSON.stringify(i,null,2)),console.log("BLOCKAPPS RESPONSE:\n"+h+"\n\n"+i+"\n")),o(n,r)}}}(this),a=null!=t?"POST":"GET";var h=this.host+"/"+this.blockchain+"/"+this.version+e;if(c.open(a,h,!0),c.setRequestHeader("Content-type",n),s=null,"application/x-www-form-urlencoded"===n){s="";for(l in t)u=t[l],""!==s&&(s+="&"),s+=l+"="+encodeURIComponent(u)}"application/json"===n&&(s=JSON.stringify(t)),this.verbosity>=3&&console.log("BLOCKAPPS REQUEST:"),this.verbosity>=2&&console.log(a+" "+h+" - "+s+" - "+n);try{return null!=s&&""!==s?c.send(s):c.send()}catch(f){return i=f,o(i)}}},{key:"requestTransactionResult",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.requestTransactionResult"),e=this.strip0x(e),this.requestFromBlockApps("/transactionResult/"+e,function(e){return function(e,n){var r;return null!=e?void t(e):0===n.length?void t(null,null):(r=n[n.length-1],null!=r.message&&r.message.toLowerCase().indexOf("success")<0?void t(new Error(r.message)):t(null,r))}}(this))}},{key:"requestTransactionData",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.requestTransactionData"),e=this.strip0x(e),this.requestFromBlockApps("/transaction?hash="+e,function(n){return function(r,o){var i;return null!=r?void t(r):0===o.length?void t(null,null):(i=o[0],n.requestFromBlockApps("/block?number="+i.blockNumber,function(r,o){var s;return null!=r?void t(r):0===o.length?void t(null,null):(s=o[0],n.requestTransactionResult(e,function(e,n){return null!=e||null==n?void t(e,n):t(null,i,s,n)}))}))}}(this))}},{key:"strip0x",value:function(e){return null==e?e:e.replace("0x","")}},{key:"eth_coinbase",value:function(e){return null==this.coinbase?e(new Error("No coinbase specified in the BlockApps + Web3 provider!")):e(null,this.coinbase)}},{key:"eth_accounts",value:function(e){return e(null,this.accounts)}},{key:"eth_blockNumber",value:function(t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_blockNumber"),this.requestFromBlockApps("/block/last/1",function(n,r){var o;if(null!=n)return void t(n);if(0===r.length)throw new Error("Couldn't find last block at /block/last/1. Please make ensure BlockApps is running properly.");return o=r[0],t(null,e.fromDecimal(o.blockData.number))})}},{key:"eth_getBlockByNumber",value:function(t,n,r){"function"==typeof n&&(r=n,n=!1);var i=new o(t,16);this.requestFromBlockApps("/block?number="+i.toString(10),function(t,o){if(null!=t)return r(t);var i=o[o.length-1],s=i.blockData,l={number:e.fromDecimal(s.number),hash:"0x"+s.parentHash,parentHash:"0x"+s.parentHash,nonce:e.fromDecimal(s.nonce),sha3Uncles:"0x"+s.unclesHash,logsBloom:"0x0",transactionsRoot:"0x"+s.transactionsRoot,stateRoot:"0x"+s.stateRoot,miner:"0x0",difficulty:e.fromDecimal(s.difficulty),totalDifficulty:e.fromDecimal(s.difficulty),extraData:"0x"+s.extraData,size:"0x0",gasLimit:e.fromDecimal(s.gasLimit),gasUsed:e.fromDecimal(s.gasUsed),timestamp:e.fromDecimal(new Date(s.timestamp).getTime())};1==n?l.transactions=i.receiptTransactions:l.transactions=i.receiptTransactions.map(function(e){return"0x"+e.hash}),l.uncles=i.blockUncles.map(function(e){return"0x"+e.hash}),r(null,l)})}},{key:"eth_getTransactionCount",value:function(t,n,r){null==n&&(n="latest"),t=this.strip0x(t),this.requestFromBlockApps("/account?address="+t,function(t,n){if(null!=t)return void r(t);var o;if(n.length){var i=n[n.length-1];o=e.fromDecimal(i.nonce)}else o="0x00";return r(null,o)})}},{key:"eth_getTransactionByHash",value:function(t,n){this.requestTransactionData(t,function(t,r,o,i){var s,l,a,c,u,h,f;if(null!=t)return void n(t);if(null==r||null==o||null==i)return void n();for(l=0,u=o.receiptTransactions,s=a=0,c=u.length;c>a;s=++a)if(f=u[s],f.r===r.r&&f.s===r.s&&f.v===r.v){l=s;break}return h={hash:"0x"+r.hash,nonce:e.fromDecimal(r.nonce),blockHash:"0x"+i.blockHash,blockNumber:e.fromDecimal(r.blockNumber),transactionIndex:e.fromDecimal(l),from:"0x"+r.from,gasPrice:e.fromDecimal(r.gasPrice),gas:e.fromDecimal(o.blockData.gasUsed),value:e.fromDecimal(r.value),input:"0x"+r.codeOrData},null!=r.to&&(h.to="0x"+r.to),n(null,h)})}},{key:"eth_getBalance",value:function(e,t,n){null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/account?address="+e,function(e,t){if(null!=e)return void n(e);if(0===t.length)return void n(null,"0x0");var r=new o(t[t.length-1].balance);n(null,"0x"+r.toString(16))})}},{key:"eth_getCode",value:function(e,t,n){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getCode"),null==t&&(t="latest"),e=this.strip0x(e),this.requestFromBlockApps("/account?address="+e,function(e,t){return null!=e?void n(e):0===t.length?void n():void n(null,"0x"+t[t.length-1].code)})}},{key:"eth_getCompilers",value:function(e){e(null,["solidity"])}},{key:"eth_compileSolidity",value:function(e,t){null==e&&(e=""),this.requestFromBlockApps("/solc",{src:e},function(n,r){var o,i,s,l,a,c,u;if(null!=n)return void t(n);if(null!=r.error)return void t(new Error(r.error));for(u={},c=r.contracts,i=s=0,l=c.length;l>s;i=++s)o=c[i],a=o.name,u[a]={code:o.bin,info:{source:e,language:"Solidity",languageVersion:"0",compilerVersion:"0",abiDefinition:r.abis[i].abi,userDoc:{methods:{}},developerDoc:{methods:{}}}};t(null,u)})}},{key:"eth_sendTransaction",value:function(e,t){return t(new Error("BlockAppsWeb3 provider can't send transactions from addresses that aren't managed by the transaction signer. Make sure your transaction signer manages this account before sendint a transaction. Account: "+e.from))}},{key:"eth_sendRawTransaction",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_sendRawTransaction"),e=this.strip0x(e);var n=new i(new s(e,"hex"));o.config({EXPONENTIAL_AT:2e7});var r=n.value.toString("hex"),a=new o(0);""!==r&&(a=new o(r,16));var c={from:n.getSenderAddress().toString("hex"),nonce:l.bufferToInt(n.nonce),gasPrice:l.bufferToInt(n.gasPrice),gasLimit:l.bufferToInt(n.gasLimit),value:a.toString(),codeOrData:n.data.toString("hex"),r:n.r.toString("hex"),s:n.s.toString("hex"),v:n.v.toString("hex"),hash:n.hash().toString("hex")};0!==n.to.length&&(c.to=n.to.toString("hex")),this.requestFromBlockApps("/transaction",c,"application/json",function(e,n){var r;return r="0x"+n.replace(/.*=/,""),t(null,r)})}},{key:"eth_call",value:function(e,t,r){function o(e,t){if(e)return r(e);var n=void 0;t&&t.vm["return"]&&(n="0x"+t.vm["return"].toString("hex")),r(null,n)}this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_call");var a=this.host+"/"+this.blockchain+"/"+this.version+"/",c=n({url:a}),u=new i({to:e.to,nonce:e.nonce||"0x00",gasPrice:e.gasPrice||"0x01",gasLimit:e.gas||"0xffffff",value:e.value||"0x00",data:e.data||"0x"}),h=e.from||this.accounts[0];u.from=new s(l.stripHexPrefix(h),"hex"),c.stateManager.checkpoint(),c.runTx({tx:u,skipNonce:!0},o)}},{key:"eth_getTransactionReceipt",value:function(t,n){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getTransactionReceipt"),this.requestTransactionData(t,function(t,r,o,i){var s,a,c,u,h,f,v,p;if(null!=t)return void n(t);if(null==r||null==o||null==i)return void n(null,null);for(c=0,f=o.receiptTransactions,a=u=0,h=f.length;h>u;a=++u)if(p=f[a],p.r===r.r&&p.s===r.s&&p.v===r.v){c=a;break}return v={blockNumber:e.fromDecimal(r.blockNumber),transactionHash:"0x"+r.hash,transactionIndex:e.fromDecimal(c),from:"0x"+r.from,cumulativeGasUsed:e.fromDecimal(o.blockData.gasUsed),gasUsed:e.fromDecimal(0),logs:[]},null!=r.to&&(v.to="0x"+r.to),s=l.generateAddress(r.from,parseInt(r.nonce)).toString("hex"),i.trace.indexOf(s)?(v.blockHash="0x"+i.blockHash,v.contractAddress="0x"+s,n(t,v)):void n(null,null)})}},{key:"eth_newBlockFilter",value:function(t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_newBlockFilter");var n=this,r=new a(this);r.initialize(function(o){return null!=o?void t(o):(n.filter_index+=1,n.filters[n.filter_index]=r,void t(null,e.fromDecimal(n.filter_index)))})}},{key:"eth_uninstallFilter",value:function(e,t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_uninstallFilter"),t(null,!0)}},{key:"eth_getFilterChanges",value:function(t,n){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_getFilterChanges");var r;return t=e.toDecimal(t),r=this.filters[t],null==r?void n(null,[]):r.getChanges(n)}},{key:"eth_gasPrice",value:function(t){this.verbosity>=1&&console.log("   BlockAppsWeb3Provider.eth_gasPrice"),this.requestFromBlockApps("/transaction/last/1",function(n,r){var o;return null!=n?void t(n):0===r.length?void t(new Error("Could not determine current gasPrice!")):(o=r[0],t(null,e.fromDecimal(o.gasPrice)))})}},{key:"web3_clientVersion",value:function(e){return e(null,"BlockApps Web3 Provider/0.0.1/JavaScript")}}]),c}(t);return c};"undefined"!=typeof module?(EthTx=require("ethereumjs-tx"),module.exports=factory(require("web3"),require("hooked-web3-provider"),require("blockapps-vm"),require("xhr2"),require("bignumber.js"),EthTx,Buffer,ethUtil)):window.BlockAppsWeb3Provider=factory(window.web3,window.HookedWeb3Provider,window.XMLHttpRequest,window.BigNumber,window.EthTx,window.Buffer,window.ethUtil);